# Knowledge Base - Documenta√ß√£o Completa

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura do Sistema](#arquitetura-do-sistema)
3. [Estrutura de Banco de Dados](#estrutura-de-banco-de-dados)
4. [Backend - API e Processamento](#backend---api-e-processamento)
5. [Frontend - Interface do Usu√°rio](#frontend---interface-do-usu√°rio)
6. [Fluxo de Dados Completo](#fluxo-de-dados-completo)
7. [Funcionalidades Principais](#funcionalidades-principais)
8. [Valida√ß√£o e Seguran√ßa](#valida√ß√£o-e-seguran√ßa)
9. [Integra√ß√£o com Agentes](#integra√ß√£o-com-agentes)

---

## Vis√£o Geral

A **Knowledge Base** √© um sistema de gerenciamento de documentos e arquivos que permite aos usu√°rios organizar informa√ß√µes em pastas, fazer upload de diversos tipos de arquivos, e atribuir esse conhecimento a agentes de IA espec√≠ficos. O sistema processa automaticamente os arquivos, gera resumos usando LLMs, e disponibiliza o conte√∫do como contexto para os agentes.

### Caracter√≠sticas Principais:

- **Organiza√ß√£o hier√°rquica**: Pastas e arquivos
- **Upload de m√∫ltiplos formatos**: TXT, PDF, DOCX, JSON, XML, CSV, Markdown, etc.
- **Processamento autom√°tico com LLM**: Gera√ß√£o de resumos inteligentes
- **Limite de armazenamento**: 50MB por usu√°rio
- **Atribui√ß√£o a agentes**: Controle granular de acesso por arquivo
- **Drag & Drop**: Interface moderna com suporte a arrastar e soltar
- **Preview de arquivos**: Visualiza√ß√£o de conte√∫do e metadados
- **Valida√ß√£o robusta**: Nomes de arquivo cross-platform seguros

---

## Arquitetura do Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         FRONTEND (Next.js)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  Knowledge Base  ‚îÇ  ‚îÇ   Tree Manager   ‚îÇ  ‚îÇ    Modals    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ      Page        ‚îÇ‚îÄ‚îÄ‚îÇ   (Drag & Drop)  ‚îÇ‚îÄ‚îÄ‚îÇ  & Dialogs   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ           ‚îÇ                     ‚îÇ                     ‚îÇ         ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                              ‚îÇ                                  ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ                    ‚îÇ   React Query     ‚îÇ                       ‚îÇ
‚îÇ                    ‚îÇ   Hooks Layer     ‚îÇ                       ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                      ‚îÇ   FastAPI REST  ‚îÇ
                      ‚îÇ   API Endpoints ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     BACKEND (Python)                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                              ‚îÇ                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ   Validation  ‚îÇ  ‚îÇ  Knowledge Base  ‚îÇ  ‚îÇ     File       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ    Module     ‚îÇ‚óÑ‚îÄ‚î§      API         ‚îÇ‚îÄ‚ñ∫‚îÇ  Processor     ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                              ‚îÇ                      ‚îÇ          ‚îÇ
‚îÇ                              ‚îÇ                      ‚îÇ          ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ                    ‚îÇ    Supabase       ‚îÇ   ‚îÇ  LLM Service  ‚îÇ ‚îÇ
‚îÇ                    ‚îÇ    Client         ‚îÇ   ‚îÇ   (Summary)   ‚îÇ ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      STORAGE & DATABASE                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  PostgreSQL DB   ‚îÇ              ‚îÇ   Supabase Storage   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                  ‚îÇ              ‚îÇ   (S3-compatible)    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Folders       ‚îÇ              ‚îÇ                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Entries       ‚îÇ              ‚îÇ  /knowledge-base/    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Assignments   ‚îÇ              ‚îÇ    /{folder}/        ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ      /{entry}/       ‚îÇ   ‚îÇ
‚îÇ                                    ‚îÇ        file.ext      ‚îÇ   ‚îÇ
‚îÇ                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Estrutura de Banco de Dados

### 1. `knowledge_base_folders`

Armazena as pastas criadas pelos usu√°rios.

```sql
CREATE TABLE knowledge_base_folders (
    folder_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_id UUID NOT NULL REFERENCES basejump.accounts(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    CONSTRAINT kb_folders_name_not_empty CHECK (LENGTH(TRIM(name)) > 0)
);
```

**Campos:**
- `folder_id`: Identificador √∫nico da pasta
- `account_id`: Refer√™ncia ao usu√°rio/conta propriet√°ria
- `name`: Nome da pasta (validado, m√°x 255 caracteres)
- `description`: Descri√ß√£o opcional da pasta
- `created_at/updated_at`: Timestamps de auditoria

**√çndices:**
- `idx_kb_folders_account_id` - Busca r√°pida por conta

---

### 2. `knowledge_base_entries`

Armazena os arquivos individuais dentro das pastas.

```sql
CREATE TABLE knowledge_base_entries (
    entry_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    folder_id UUID NOT NULL REFERENCES knowledge_base_folders(folder_id) ON DELETE CASCADE,
    account_id UUID NOT NULL REFERENCES basejump.accounts(id) ON DELETE CASCADE,
    
    filename VARCHAR(255) NOT NULL,
    file_path TEXT NOT NULL,  -- S3: knowledge-base/{folder_id}/{entry_id}/{filename}
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(255),
    
    summary TEXT NOT NULL,  -- Gerado por LLM
    usage_context VARCHAR(100) DEFAULT 'always',  -- 'always', 'on_request', 'contextual'
    
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    CONSTRAINT kb_entries_filename_not_empty CHECK (LENGTH(TRIM(filename)) > 0),
    CONSTRAINT kb_entries_summary_not_empty CHECK (LENGTH(TRIM(summary)) > 0),
    CONSTRAINT kb_entries_file_size_positive CHECK (file_size > 0)
);
```

**Campos principais:**
- `entry_id`: Identificador √∫nico do arquivo
- `folder_id`: Pasta onde est√° armazenado
- `filename`: Nome original do arquivo
- `file_path`: Caminho no storage S3
- `file_size`: Tamanho em bytes (usado para controle de quota)
- `mime_type`: Tipo MIME do arquivo
- `summary`: Resumo gerado automaticamente por LLM (200-300 palavras)
- `usage_context`: Quando usar este arquivo (sempre, sob demanda, contextual)
- `is_active`: Soft delete flag

**√çndices:**
- `idx_kb_entries_folder_id` - Busca por pasta
- `idx_kb_entries_account_id` - Busca por conta

---

### 3. `agent_knowledge_entry_assignments`

Relacionamento entre agentes e arquivos da knowledge base.

```sql
CREATE TABLE agent_knowledge_entry_assignments (
    assignment_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL REFERENCES agents(agent_id) ON DELETE CASCADE,
    entry_id UUID NOT NULL REFERENCES knowledge_base_entries(entry_id) ON DELETE CASCADE,
    account_id UUID NOT NULL REFERENCES basejump.accounts(id) ON DELETE CASCADE,
    
    enabled BOOLEAN DEFAULT TRUE,
    assigned_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(agent_id, entry_id)
);
```

**Campos:**
- `assignment_id`: ID da atribui√ß√£o
- `agent_id`: Agente que tem acesso
- `entry_id`: Arquivo acess√≠vel
- `enabled`: Flag para ativar/desativar acesso sem deletar
- Constraint `UNIQUE(agent_id, entry_id)` previne duplicatas

**√çndices:**
- `idx_kb_entry_assignments_agent_id` - Busca r√°pida por agente
- `idx_kb_entry_assignments_entry_id` - Busca r√°pida por arquivo

---

### 4. Fun√ß√£o: `get_agent_knowledge_base_context()`

Fun√ß√£o PostgreSQL que retorna o contexto formatado para um agente.

```sql
CREATE OR REPLACE FUNCTION get_agent_knowledge_base_context(
    p_agent_id UUID,
    p_max_tokens INTEGER DEFAULT 4000
)
RETURNS TEXT
```

**Funcionamento:**
1. Busca todos os arquivos atribu√≠dos ao agente (`agent_id`)
2. Filtra por `enabled = TRUE` e `is_active = TRUE`
3. Considera apenas `usage_context IN ('always', 'contextual')`
4. Estima tokens (‚âà4 caracteres por token)
5. Retorna texto formatado at√© o limite de tokens
6. Formato de sa√≠da:
   ```markdown
   # KNOWLEDGE BASE
   
   The following files are available in your knowledge base:
   
   ## {folder_name}/{filename}
   {summary}
   
   ## {folder_name}/{filename}
   {summary}
   ```

**Uso:** Injetado automaticamente no contexto de conversa√ß√£o dos agentes.

---

## Backend - API e Processamento

### Estrutura de M√≥dulos

```
backend/core/knowledge_base/
‚îú‚îÄ‚îÄ __init__.py              # Module initialization
‚îú‚îÄ‚îÄ api.py                   # FastAPI endpoints (602 linhas)
‚îú‚îÄ‚îÄ file_processor.py        # File processing & LLM summary (365 linhas)
‚îî‚îÄ‚îÄ validation.py            # Name validation & sanitization (177 linhas)
```

---

### API Endpoints (`api.py`)

#### Constantes
```python
MAX_TOTAL_FILE_SIZE = 50 * 1024 * 1024  # 50MB total per user
```

#### Endpoints de Pastas

**GET `/knowledge-base/folders`**
- Retorna todas as pastas do usu√°rio
- Inclui contagem de arquivos em cada pasta
- Response: `List[FolderResponse]`

**POST `/knowledge-base/folders`**
- Cria nova pasta
- Valida nome (caracteres ilegais, nomes reservados)
- Gera nome √∫nico se houver conflito (ex: "Docs" ‚Üí "Docs 2")
- Body: `FolderRequest { name, description? }`

**PUT `/knowledge-base/folders/{folder_id}`**
- Atualiza nome e/ou descri√ß√£o da pasta
- Verifica ownership
- Valida nome se fornecido
- Body: `UpdateFolderRequest { name?, description? }`

**DELETE `/knowledge-base/folders/{folder_id}`**
- Deleta pasta e todos os arquivos dentro
- Remove arquivos f√≠sicos do S3
- Cascade delete para entries e assignments
- Verifica ownership antes de deletar

---

#### Endpoints de Arquivos

**POST `/knowledge-base/folders/{folder_id}/upload`**
- Upload de arquivo para uma pasta
- Valida:
  - Ownership da pasta
  - Tamanho do arquivo individual
  - Limite total de 50MB por usu√°rio
  - Tipo de arquivo suportado
- Gera nome √∫nico se houver conflito
- Processa arquivo e gera resumo LLM
- Armazena no S3: `knowledge-base/{folder_id}/{entry_id}/{filename}`
- Response: `EntryResponse`

**GET `/knowledge-base/folders/{folder_id}/entries`**
- Lista todos os arquivos de uma pasta
- Ordenado por `created_at DESC`
- Apenas arquivos ativos (`is_active = TRUE`)
- Response: `List[EntryResponse]`

**PUT `/knowledge-base/entries/{entry_id}`**
- Atualiza resumo de um arquivo
- Body: `UpdateEntryRequest { summary }`
- Verifica ownership
- Mant√©m hist√≥rico via `updated_at`

**DELETE `/knowledge-base/entries/{entry_id}`**
- Remove arquivo
- Deleta do S3
- Remove do banco de dados
- Remove assignments automaticamente (cascade)

**POST `/knowledge-base/files/{file_id}/move`**
- Move arquivo entre pastas (drag & drop)
- Valida ownership de ambas as pastas
- Atualiza `folder_id`
- Body: `FolderMoveRequest { target_folder_id }`

---

#### Endpoints de Atribui√ß√µes (Agent Assignments)

**GET `/knowledge-base/agents/{agent_id}/assignments`**
- Retorna lista de `entry_ids` atribu√≠dos ao agente
- Usado para sincronizar checkboxes na UI

**POST `/knowledge-base/agents/{agent_id}/assignments`**
- Atualiza atribui√ß√µes do agente
- Recebe lista completa de `entry_ids`
- Implementa diff: adiciona novos, remove antigos
- Body: `AgentAssignmentRequest { entry_ids: List[str] }`
- Transa√ß√£o at√¥mica para consist√™ncia

---

### File Processor (`file_processor.py`)

#### Classe `FileProcessor`

**Constantes:**
```python
SUPPORTED_EXTENSIONS = {'.txt', '.pdf', '.docx'}
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50MB
```

**Nota:** O sistema tamb√©m aceita arquivos text-based (JSON, XML, CSV, Markdown, etc.) mesmo que n√£o estejam nas extens√µes suportadas, usando detec√ß√£o de encoding.

---

#### M√©todo: `process_file()`

Fluxo completo de processamento:

```python
async def process_file(
    account_id: str,
    folder_id: str,
    file_content: bytes,
    filename: str,
    mime_type: str
) -> Dict[str, Any]
```

**Etapas:**

1. **Valida√ß√£o de tamanho**
   ```python
   if len(file_content) > self.MAX_FILE_SIZE:
       raise ValueError(f"File too large: {len(file_content)} bytes")
   ```

2. **Detec√ß√£o de tipo de arquivo**
   - Verifica `mime_type` (text/*, application/json, etc.)
   - Usa `chardet` para detectar encoding
   - Analisa ratio de caracteres imprim√≠veis
   - Determina se √© texto ou bin√°rio

3. **Sanitiza√ß√£o do nome**
   ```python
   sanitized_filename = self.sanitize_filename(filename)
   # Remove emojis, caracteres especiais, normaliza espa√ßos
   ```

4. **Upload para S3**
   ```python
   s3_path = f"knowledge-base/{folder_id}/{entry_id}/{sanitized_filename}"
   await client.storage.from_('file-uploads').upload(s3_path, file_content)
   ```

5. **Extra√ß√£o de conte√∫do**
   - `.txt`, `.json`, `.xml`, `.csv`, `.md`: Decodifica com charset detection
   - `.pdf`: Usa `PyPDF2` para extrair texto de todas as p√°ginas
   - `.docx`: Usa `python-docx` para extrair par√°grafos
   - Outros: Tenta decodificar como texto, fallback para placeholder

6. **Gera√ß√£o de resumo LLM**
   ```python
   summary = await self._generate_summary(content, filename)
   ```

7. **Salvar no banco de dados**
   ```python
   entry_data = {
       'entry_id': entry_id,
       'folder_id': folder_id,
       'account_id': account_id,
       'filename': filename,
       'file_path': s3_path,
       'file_size': len(file_content),
       'mime_type': mime_type,
       'summary': summary,
       'is_active': True
   }
   await client.table('knowledge_base_entries').insert(entry_data).execute()
   ```

---

#### M√©todo: `_generate_summary()`

Sistema de gera√ß√£o de resumo com fallback inteligente:

**Modelos em ordem de prioridade:**
1. `google/gemini-2.5-flash-lite` (1M tokens context)
2. `openrouter/google/gemini-2.5-flash-lite` (1M tokens - fallback)
3. `gpt-5-mini` (400K tokens - fallback final)

**Estrat√©gia de Chunking Inteligente:**

Se o conte√∫do exceder o limite de tokens:

```python
def _smart_chunk_content(self, content: str, max_chars: int) -> str:
    quarter = max_chars // 4
    
    # Sempre inclui in√≠cio (mais importante)
    beginning = content[:quarter * 2]
    
    # Inclui final (conclus√£o/resumo)
    ending = content[-quarter:]
    
    # Busca se√ß√µes importantes no meio:
    # - Headers (texto em mai√∫sculas)
    # - Listas (‚Ä¢, -, *, 1., 2.)
    # - Palavras-chave (summary, conclusion, important, key, main)
    # - Linhas curtas (< 100 chars, geralmente importantes)
    
    return f"{beginning}\n\n[KEY SECTIONS]\n{middle_section}\n\n[ENDING]\n{ending}"
```

**Prompt para LLM:**
```
Analyze this file and create a concise, actionable summary for an AI agent's knowledge base.

File: {filename}
Content: {processed_content}

Generate a 2-3 sentence summary that captures:
1. What this file contains
2. Key information or purpose  
3. When this knowledge would be useful

Keep it under 200 words and make it actionable for context injection.
```

**Fallback Inteligente:**

Se todos os LLMs falharem, gera resumo baseado em an√°lise de conte√∫do:

```python
def _create_fallback_summary(self, content: str, filename: str) -> str:
    # Detecta tipo de conte√∫do pela extens√£o
    # Analisa primeiras 2000 caracteres
    # Conta linhas n√£o vazias
    # Retorna: "This {content_type} '{filename}' contains X characters 
    #           across Y lines. Preview: {first_200_chars}..."
```

---

### Validation Module (`validation.py`)

#### Classe `FileNameValidator`

Sistema robusto de valida√ß√£o cross-platform.

**Caracteres Ilegais:**
```python
ILLEGAL_CHARS = r'[<>:"/\\|?*\x00-\x1f]'
# Windows + caracteres de controle
```

**Nomes Reservados (Windows):**
```python
RESERVED_NAMES = {
    'CON', 'PRN', 'AUX', 'NUL',
    'COM1', 'COM2', ..., 'COM9',
    'LPT1', 'LPT2', ..., 'LPT9'
}
```

---

#### M√©todo: `validate_name()`

```python
@classmethod
def validate_name(cls, name: str, item_type: str = "file") -> Tuple[bool, Optional[str]]:
```

**Valida√ß√µes realizadas:**

1. **Nome vazio ou apenas espa√ßos**
   ```python
   if not name or not name.strip():
       return False, f"{item_type} name cannot be empty"
   ```

2. **Comprimento m√°ximo**
   - 255 caracteres Unicode
   - 200 bytes quando codificado em UTF-8

3. **Caracteres ilegais**
   - Detecta `< > : " / \ | ? *` e caracteres de controle
   - Retorna lista de caracteres problem√°ticos

4. **Pontos e espa√ßos nas extremidades**
   ```python
   if name.startswith('.') or name.endswith('.'):
       return False, "Cannot start or end with dots"
   ```

5. **Nomes reservados**
   - Verifica se o base name (antes da extens√£o) est√° em `RESERVED_NAMES`
   - Case-insensitive

6. **Nomes apenas com pontos**
   ```python
   if all(c == '.' for c in name):
       return False, "Cannot consist only of dots"
   ```

---

#### M√©todo: `sanitize_name()`

Limpa o nome automaticamente:

```python
@classmethod
def sanitize_name(cls, name: str) -> str:
    # 1. Remove espa√ßos nas extremidades
    name = name.strip()
    
    # 2. Remove caracteres ilegais
    name = re.sub(cls.ILLEGAL_CHARS, '', name)
    
    # 3. Remove pontos/espa√ßos nas extremidades
    name = name.strip('. ')
    
    # 4. Normaliza Unicode (NFKC)
    name = unicodedata.normalize('NFKC', name)
    
    # 5. Adiciona underscore se for nome reservado
    if base_name in cls.RESERVED_NAMES:
        name = f"_{name}"
    
    # 6. Limita a 200 bytes UTF-8
    if len(name.encode('utf-8')) > 200:
        name = name[:200]
    
    # 7. Fallback para "Untitled"
    return name or "Untitled"
```

---

#### M√©todo: `generate_unique_name()`

Gera nomes √∫nicos estilo macOS:

```python
@classmethod
def generate_unique_name(cls, base_name: str, existing_names: list, item_type: str) -> str:
```

**Exemplos:**
- `"document.txt"` ‚Üí j√° existe ‚Üí `"document 2.txt"`
- `"document 2.txt"` ‚Üí j√° existe ‚Üí `"document 3.txt"`
- `"My Folder"` ‚Üí j√° existe ‚Üí `"My Folder 2"`

**Algoritmo:**
1. Sanitiza o nome base
2. Se √∫nico, retorna imediatamente
3. Separa nome e extens√£o (para arquivos)
4. Incrementa contador (2, 3, 4, ...)
5. Testa cada varia√ß√£o at√© encontrar nome √∫nico
6. Safety break em 1000 itera√ß√µes (adiciona UUID)

**Compara√ß√£o case-insensitive:**
```python
if base_name.lower() not in [name.lower() for name in existing_names]:
```

---

## Frontend - Interface do Usu√°rio

### Estrutura de Componentes

```
frontend/src/components/knowledge-base/
‚îú‚îÄ‚îÄ knowledge-base-page.tsx           # Page wrapper
‚îú‚îÄ‚îÄ knowledge-base-header.tsx         # Header component
‚îú‚îÄ‚îÄ knowledge-base-manager.tsx        # Main manager (1169 linhas)
‚îú‚îÄ‚îÄ shared-kb-tree.tsx                # Tree item & drag overlay
‚îú‚îÄ‚îÄ unified-kb-entry-modal.tsx        # Create/upload modal
‚îú‚îÄ‚îÄ kb-file-preview-modal.tsx         # File preview
‚îú‚îÄ‚îÄ edit-summary-modal.tsx            # Edit summary
‚îî‚îÄ‚îÄ kb-delete-confirm-dialog.tsx      # Delete confirmation
```

---

### Component: `KnowledgeBasePage`

Componente raiz da p√°gina.

```tsx
export function KnowledgeBasePage() {
    return (
        <div className="min-h-screen">
            <div className="container mx-auto max-w-7xl px-4 py-8">
                <KnowledgeBasePageHeader />
            </div>
            <div className="container mx-auto max-w-7xl px-4 py-2">
                <KnowledgeBaseManager
                    showHeader={true}
                    showRecentFiles={true}
                    enableAssignments={false}  // Modo standalone
                />
            </div>
        </div>
    );
}
```

---

### Component: `KnowledgeBaseManager`

Componente principal com 1169 linhas.

#### Props Interface

```typescript
interface KnowledgeBaseManagerProps {
    // Agent context (opcional)
    agentId?: string;
    agentName?: string;
    
    // UI customization
    showHeader?: boolean;
    headerTitle?: string;
    headerDescription?: string;
    showRecentFiles?: boolean;
    emptyStateMessage?: string;
    emptyStateContent?: React.ReactNode;
    maxHeight?: string;
    
    // Modo de atribui√ß√£o
    enableAssignments?: boolean;  // true quando usado na p√°gina de agente
}
```

**Modos de opera√ß√£o:**

1. **Standalone Mode** (`enableAssignments: false`)
   - P√°gina `/knowledge` principal
   - CRUD completo de pastas e arquivos
   - Sem checkboxes de sele√ß√£o

2. **Assignment Mode** (`enableAssignments: true`)
   - Usada dentro da configura√ß√£o do agente
   - Checkboxes para selecionar arquivos
   - Auto-expande todas as pastas
   - Auto-carrega todos os entries
   - Salva assignments automaticamente

---

#### State Management

```typescript
// Tree data structure
const [treeData, setTreeData] = useState<TreeItem[]>([]);

interface TreeItem {
    id: string;
    type: 'folder' | 'file';
    name: string;
    parentId?: string;
    data?: Folder | Entry;
    children?: TreeItem[];
    expanded?: boolean;
}

// Folder entries cache
const [folderEntries, setFolderEntries] = useState<{ [folderId: string]: Entry[] }>({});

// Loading states
const [loadingFolders, setLoadingFolders] = useState<{ [folderId: string]: boolean }>({});
const [movingFiles, setMovingFiles] = useState<{ [fileId: string]: boolean }>({});

// Edit mode
const [editingFolder, setEditingFolder] = useState<string | null>(null);
const [editingName, setEditingName] = useState('');
const [validationError, setValidationError] = useState<string | null>(null);

// Drag & Drop
const [activeId, setActiveId] = useState<string | null>(null);

// Assignment mode (quando enableAssignments: true)
const [selectedEntries, setSelectedEntries] = useState<Set<string>>(new Set());
const [assignmentsLoading, setAssignmentsLoading] = useState(false);

// Upload progress tracking
const [uploadStatus, setUploadStatus] = useState<{
    [folderId: string]: {
        isUploading: boolean;
        progress: number;
        currentFile?: string;
        totalFiles?: number;
        completedFiles?: number;
    };
}>({});
```

---

#### React Query Hooks

```typescript
import { useKnowledgeFolders } from '@/hooks/react-query/knowledge-base/use-folders';

const { 
    folders,           // List<Folder>
    recentFiles,       // List<Entry> (√∫ltimos 10)
    loading,           // boolean
    refetch            // function
} = useKnowledgeFolders();
```

---

#### Tree Building Effect

```typescript
React.useEffect(() => {
    const buildTree = () => {
        const tree: TreeItem[] = folders.map(folder => {
            const existingFolder = treeData.find(item => item.id === folder.folder_id);
            
            // Auto-expand em modo assignment
            const isExpanded = enableAssignments 
                ? true 
                : (existingFolder?.expanded || false);

            return {
                id: folder.folder_id,
                type: 'folder',
                name: folder.name,
                data: folder,
                children: folderEntries[folder.folder_id]?.map(entry => ({
                    id: entry.entry_id,
                    type: 'file',
                    name: entry.filename,
                    parentId: folder.folder_id,
                    data: entry,
                })) || [],
                expanded: isExpanded,
            };
        });
        setTreeData(tree);
    };

    buildTree();
}, [folders, folderEntries, enableAssignments]);
```

---

#### Assignment Mode Effects

```typescript
// Auto-load assignments quando em modo assignment
React.useEffect(() => {
    if (enableAssignments && agentId) {
        loadAssignments();
        
        // Auto-fetch todos os folder entries
        if (!foldersLoading && folders.length > 0) {
            folders.forEach(folder => {
                if (!folderEntries[folder.folder_id]) {
                    fetchFolderEntries(folder.folder_id);
                }
            });
        }
    }
}, [enableAssignments, agentId, folders, foldersLoading]);

// Load assignments from API
const loadAssignments = async () => {
    const response = await fetch(
        `${API_URL}/knowledge-base/agents/${agentId}/assignments`,
        { headers: { 'Authorization': `Bearer ${token}` } }
    );
    const data = await response.json();
    setSelectedEntries(new Set(data.entry_ids));
};
```

---

#### Drag & Drop System

Usa `@dnd-kit` para implementar arrastar e soltar.

**Sensors:**
```typescript
const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
        coordinateGetter: sortableKeyboardCoordinates,
    })
);
```

**Drag Start:**
```typescript
const handleDragStart = (event: DragStartEvent) => {
    setActiveId(event.active.id as string);
};
```

**Drag End:**
```typescript
const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    
    if (!over || active.id === over.id) {
        setActiveId(null);
        return;
    }
    
    // Encontra item sendo arrastado
    const draggedItem = findItemById(active.id as string);
    const targetItem = findItemById(over.id as string);
    
    // S√≥ permite arrastar arquivos para pastas
    if (draggedItem?.type === 'file' && targetItem?.type === 'folder') {
        await moveFile(draggedItem.id, targetItem.id);
    }
    
    setActiveId(null);
};
```

**Move File API:**
```typescript
const moveFile = async (fileId: string, targetFolderId: string) => {
    setMovingFiles(prev => ({ ...prev, [fileId]: true }));
    
    try {
        const response = await fetch(
            `${API_URL}/knowledge-base/files/${fileId}/move`,
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ target_folder_id: targetFolderId })
            }
        );
        
        if (response.ok) {
            toast.success('File moved successfully');
            await refetchFolders();
            await fetchFolderEntries(targetFolderId);
        }
    } finally {
        setMovingFiles(prev => ({ ...prev, [fileId]: false }));
    }
};
```

---

#### Edit Folder Name (Inline)

**Start Edit:**
```typescript
const handleStartEdit = (folderId: string, currentName: string) => {
    setEditingFolder(folderId);
    setEditingName(currentName);
    setValidationError(null);
    
    // Focus e select text
    setTimeout(() => {
        editInputRef.current?.focus();
        editInputRef.current?.select();
    }, 0);
};
```

**Validate on Change:**
```typescript
const handleEditChange = (newName: string) => {
    setEditingName(newName);
    
    // Nomes existentes (exceto o atual)
    const existingNames = folders
        .map(f => f.name)
        .filter(name => name !== currentFolder.name);
    
    // Valida√ß√£o
    const nameValidation = FileNameValidator.validateName(newName, 'folder');
    const hasConflict = nameValidation.isValid && 
        FileNameValidator.checkNameConflict(newName, existingNames);
    
    const errorMessage = hasConflict
        ? 'A folder with this name already exists'
        : FileNameValidator.getFriendlyErrorMessage(newName, 'folder');
    
    setValidationError(isValid ? null : errorMessage);
};
```

**Finish Edit:**
```typescript
const handleFinishEdit = async () => {
    if (!editingFolder || !editingName.trim()) return;
    
    const trimmedName = editingName.trim();
    
    // Valida√ß√£o final
    if (!isValid) {
        toast.error(errorMessage);
        return;
    }
    
    // Update via Supabase direct
    const { error } = await supabase
        .from('knowledge_base_folders')
        .update({ name: trimmedName })
        .eq('folder_id', editingFolder);
    
    if (error) {
        toast.error('Failed to rename folder');
    } else {
        toast.success('Folder renamed successfully');
        refetchFolders();
    }
    
    // Clear edit state
    setEditingFolder(null);
    setEditingName('');
    setValidationError(null);
};
```

**Keyboard Support:**
```typescript
const handleEditKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
        handleFinishEdit();
    } else if (e.key === 'Escape') {
        // Cancel edit
        setEditingFolder(null);
        setEditingName('');
        setValidationError(null);
    }
};
```

---

#### File Upload with Progress

**Upload Handler:**
```typescript
const handleUpload = async (folderId: string, files: FileList) => {
    const fileArray = Array.from(files);
    
    setUploadStatus(prev => ({
        ...prev,
        [folderId]: {
            isUploading: true,
            progress: 0,
            totalFiles: fileArray.length,
            completedFiles: 0
        }
    }));
    
    for (let i = 0; i < fileArray.length; i++) {
        const file = fileArray[i];
        
        setUploadStatus(prev => ({
            ...prev,
            [folderId]: {
                ...prev[folderId],
                currentFile: file.name,
                progress: Math.round(((i + 1) / fileArray.length) * 100)
            }
        }));
        
        const formData = new FormData();
        formData.append('file', file);
        
        await fetch(
            `${API_URL}/knowledge-base/folders/${folderId}/upload`,
            {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            }
        );
        
        setUploadStatus(prev => ({
            ...prev,
            [folderId]: {
                ...prev[folderId],
                completedFiles: i + 1
            }
        }));
    }
    
    // Cleanup
    setUploadStatus(prev => ({
        ...prev,
        [folderId]: {
            isUploading: false,
            progress: 100
        }
    }));
    
    toast.success(`${fileArray.length} file(s) uploaded successfully`);
    await fetchFolderEntries(folderId);
};
```

---

#### Assignment Functions (Checkbox Selection)

**Get Folder Selection State:**
```typescript
const getFolderSelectionState = (folderId: string) => {
    const folder = treeData.find(f => f.id === folderId);
    if (!folder?.children || folder.children.length === 0) {
        return { selected: false, indeterminate: false };
    }
    
    const folderEntryIds = folder.children.map(child => child.id);
    const selectedCount = folderEntryIds.filter(id => selectedEntries.has(id)).length;
    
    if (selectedCount === 0) {
        return { selected: false, indeterminate: false };
    } else if (selectedCount === folderEntryIds.length) {
        return { selected: true, indeterminate: false };
    } else {
        return { selected: false, indeterminate: true };  // Partial selection
    }
};
```

**Toggle Entry:**
```typescript
const toggleEntrySelection = async (entryId: string) => {
    const newSelection = new Set(selectedEntries);
    
    if (newSelection.has(entryId)) {
        newSelection.delete(entryId);
    } else {
        newSelection.add(entryId);
    }
    
    setSelectedEntries(newSelection);
    await saveAssignments(newSelection);
};
```

**Toggle Folder (Select/Deselect All):**
```typescript
const toggleFolderSelection = async (folderId: string) => {
    const folder = treeData.find(f => f.id === folderId);
    if (!folder?.children) return;
    
    const folderEntryIds = folder.children.map(child => child.id);
    const allSelected = folderEntryIds.every(id => selectedEntries.has(id));
    
    const newSelection = new Set(selectedEntries);
    
    if (allSelected) {
        // Deselect all
        folderEntryIds.forEach(id => newSelection.delete(id));
    } else {
        // Select all
        folderEntryIds.forEach(id => newSelection.add(id));
    }
    
    setSelectedEntries(newSelection);
    await saveAssignments(newSelection);
};
```

**Save Assignments:**
```typescript
const saveAssignments = async (selectedSet: Set<string>) => {
    if (!agentId) return;
    
    try {
        await fetch(
            `${API_URL}/knowledge-base/agents/${agentId}/assignments`,
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ entry_ids: Array.from(selectedSet) })
            }
        );
        
        toast.success('Knowledge base access updated');
    } catch (error) {
        toast.error('Failed to save assignments');
    }
};
```

---

#### Render Tree

```tsx
<DndContext
    sensors={sensors}
    collisionDetection={closestCenter}
    onDragStart={handleDragStart}
    onDragEnd={handleDragEnd}
>
    <SortableContext
        items={treeData.map(item => item.id)}
        strategy={verticalListSortingStrategy}
    >
        {treeData.map(folder => (
            <div key={folder.id}>
                {/* Folder Row */}
                <div className="flex items-center gap-2">
                    {/* Expand/Collapse Icon */}
                    <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => handleExpand(folder.id)}
                    >
                        {folder.expanded ? <ChevronDownIcon /> : <ChevronRightIcon />}
                    </Button>
                    
                    {/* Checkbox (assignment mode) */}
                    {enableAssignments && (
                        <Checkbox
                            checked={getFolderSelectionState(folder.id).selected}
                            indeterminate={getFolderSelectionState(folder.id).indeterminate}
                            onCheckedChange={() => toggleFolderSelection(folder.id)}
                        />
                    )}
                    
                    <FolderIcon />
                    
                    {/* Folder Name (editable) */}
                    {editingFolder === folder.id ? (
                        <Input
                            ref={editInputRef}
                            value={editingName}
                            onChange={(e) => handleEditChange(e.target.value)}
                            onBlur={handleFinishEdit}
                            onKeyDown={handleEditKeyPress}
                        />
                    ) : (
                        <span onClick={() => handleStartEdit(folder.id, folder.name)}>
                            {folder.name}
                        </span>
                    )}
                    
                    {/* Actions Menu */}
                    <DropdownMenu>
                        <DropdownMenuTrigger>
                            <MoreVerticalIcon />
                        </DropdownMenuTrigger>
                        <DropdownMenuContent>
                            <DropdownMenuItem onClick={() => handleRename(folder.id)}>
                                Rename
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleDelete(folder.id)}>
                                Delete
                            </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                </div>
                
                {/* Children (Files) */}
                {folder.expanded && (
                    <div className="ml-6">
                        {loadingFolders[folder.id] ? (
                            <Skeleton className="h-8 w-full" />
                        ) : (
                            folder.children?.map(file => (
                                <div key={file.id} className="flex items-center gap-2">
                                    {/* Checkbox (assignment mode) */}
                                    {enableAssignments && (
                                        <Checkbox
                                            checked={selectedEntries.has(file.id)}
                                            onCheckedChange={() => toggleEntrySelection(file.id)}
                                        />
                                    )}
                                    
                                    <FileIcon />
                                    <span onClick={() => handleFileSelect(file)}>
                                        {file.name}
                                    </span>
                                    
                                    {/* File Actions */}
                                    <DropdownMenu>
                                        <DropdownMenuItem onClick={() => handlePreview(file)}>
                                            Preview
                                        </DropdownMenuItem>
                                        <DropdownMenuItem onClick={() => handleEditSummary(file)}>
                                            Edit Summary
                                        </DropdownMenuItem>
                                        <DropdownMenuItem onClick={() => handleDownload(file)}>
                                            Download
                                        </DropdownMenuItem>
                                        <DropdownMenuItem onClick={() => handleDelete(file)}>
                                            Delete
                                        </DropdownMenuItem>
                                    </DropdownMenu>
                                </div>
                            ))
                        )}
                    </div>
                )}
            </div>
        ))}
    </SortableContext>
    
    {/* Drag Overlay */}
    <DragOverlay>
        {activeId ? <FileDragOverlay name={activeItem?.name} /> : null}
    </DragOverlay>
</DndContext>
```

---

## Fluxo de Dados Completo

### 1. Upload de Arquivo - Fluxo Detalhado

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    USER UPLOADS FILE                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND: knowledge-base-manager.tsx                            ‚îÇ
‚îÇ  - User selects folder                                           ‚îÇ
‚îÇ  - Clicks upload button                                          ‚îÇ
‚îÇ  - Selects file(s) from file picker                             ‚îÇ
‚îÇ  - handleUpload() called                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND: Create FormData                                       ‚îÇ
‚îÇ  - formData.append('file', file)                                 ‚îÇ
‚îÇ  - Track upload progress in state                                ‚îÇ
‚îÇ  - Show progress indicator                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº POST /knowledge-base/folders/{id}/upload
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: api.py - upload_file()                                 ‚îÇ
‚îÇ  ‚úì Verify JWT token                                             ‚îÇ
‚îÇ  ‚úì Check folder ownership                                       ‚îÇ
‚îÇ  ‚úì Check file size limit (individual)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: api.py - check_total_file_size_limit()                 ‚îÇ
‚îÇ  - Query total size of user's files                             ‚îÇ
‚îÇ  - Calculate: current_total + new_file_size                     ‚îÇ
‚îÇ  - If > 50MB: raise HTTPException 413                           ‚îÇ
‚îÇ  - Else: continue                                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: validation.py - validate_file_name_unique()            ‚îÇ
‚îÇ  - Get existing filenames in folder                             ‚îÇ
‚îÇ  - If conflict: generate unique name                            ‚îÇ
‚îÇ    Example: "doc.txt" ‚Üí "doc 2.txt"                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: file_processor.py - process_file()                     ‚îÇ
‚îÇ  1. Validate file size again                                    ‚îÇ
‚îÇ  2. Detect file type (mime + content analysis)                  ‚îÇ
‚îÇ  3. Sanitize filename (remove emojis, special chars)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: Upload to Supabase Storage (S3)                        ‚îÇ
‚îÇ  - Generate entry_id (UUID)                                     ‚îÇ
‚îÇ  - Path: knowledge-base/{folder_id}/{entry_id}/{filename}       ‚îÇ
‚îÇ  - await client.storage.from_('file-uploads').upload()          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: file_processor.py - _extract_content()                 ‚îÇ
‚îÇ  - .txt/.json/.xml/.csv: decode with chardet                    ‚îÇ
‚îÇ  - .pdf: PyPDF2.PdfReader ‚Üí extract_text()                      ‚îÇ
‚îÇ  - .docx: docx.Document ‚Üí paragraphs                            ‚îÇ
‚îÇ  - Other: try decode as text, fallback to placeholder           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: file_processor.py - _generate_summary()                ‚îÇ
‚îÇ  1. Estimate tokens (length / 4)                                ‚îÇ
‚îÇ  2. Try models in order:                                        ‚îÇ
‚îÇ     a) google/gemini-2.5-flash-lite (1M context)                ‚îÇ
‚îÇ     b) openrouter/google/gemini-2.5-flash-lite                  ‚îÇ
‚îÇ     c) gpt-5-mini (400K context)                                ‚îÇ
‚îÇ  3. If content > context limit:                                 ‚îÇ
‚îÇ     - Use _smart_chunk_content()                                ‚îÇ
‚îÇ     - Include: beginning + key sections + ending                ‚îÇ
‚îÇ  4. Call make_llm_api_call() with prompt                        ‚îÇ
‚îÇ  5. If all fail: _create_fallback_summary()                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: Save to Database                                       ‚îÇ
‚îÇ  - Insert into knowledge_base_entries                           ‚îÇ
‚îÇ  - Fields: entry_id, folder_id, account_id,                     ‚îÇ
‚îÇ           filename, file_path, file_size,                       ‚îÇ
‚îÇ           mime_type, summary, is_active                         ‚îÇ
‚îÇ  - Timestamps: created_at, updated_at                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: Return Response                                        ‚îÇ
‚îÇ  - EntryResponse with entry_id, filename, summary, etc.         ‚îÇ
‚îÇ  - HTTP 200 OK                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND: Update UI                                             ‚îÇ
‚îÇ  - Clear upload progress                                        ‚îÇ
‚îÇ  - Show success toast                                           ‚îÇ
‚îÇ  - Refresh folder entries                                       ‚îÇ
‚îÇ  - File appears in tree view                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 2. Agent Assignment - Fluxo Detalhado

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  USER OPENS AGENT CONFIGURATION                                  ‚îÇ
‚îÇ  - Navigates to /agents/{agent_id}                              ‚îÇ
‚îÇ  - Clicks "Knowledge Base" tab                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND: Render KnowledgeBaseManager                           ‚îÇ
‚îÇ  - Props: agentId, agentName                                    ‚îÇ
‚îÇ  - enableAssignments: true                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND: useEffect - Load Assignments                          ‚îÇ
‚îÇ  - Detect: enableAssignments && agentId                         ‚îÇ
‚îÇ  - Call: loadAssignments()                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº GET /knowledge-base/agents/{id}/assignments
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: api.py - get_agent_assignments()                       ‚îÇ
‚îÇ  - Verify JWT                                                   ‚îÇ
‚îÇ  - Query agent_knowledge_entry_assignments                      ‚îÇ
‚îÇ  - Filter: agent_id = {id} AND enabled = true                  ‚îÇ
‚îÇ  - Return: { entry_ids: [uuid1, uuid2, ...] }                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND: setSelectedEntries(new Set(entry_ids))                ‚îÇ
‚îÇ  - Update state with current assignments                        ‚îÇ
‚îÇ  - Checkboxes reflect assigned files                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND: useEffect - Auto-Expand & Fetch                       ‚îÇ
‚îÇ  - Auto-expand all folders (assignment mode)                    ‚îÇ
‚îÇ  - For each folder: fetchFolderEntries(folder_id)               ‚îÇ
‚îÇ  - Loads all files to show complete selection state             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  USER TOGGLES CHECKBOX                                           ‚îÇ
‚îÇ  - Can click file checkbox (individual)                         ‚îÇ
‚îÇ  - Or folder checkbox (select/deselect all)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND: toggleEntrySelection() or toggleFolderSelection()     ‚îÇ
‚îÇ  - Update selectedEntries Set                                   ‚îÇ
‚îÇ  - Add or remove entry_id                                       ‚îÇ
‚îÇ  - Call: saveAssignments(newSelection)                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº POST /knowledge-base/agents/{id}/assignments
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: api.py - update_agent_assignments()                    ‚îÇ
‚îÇ  - Receive: { entry_ids: [uuid1, uuid2, ...] }                 ‚îÇ
‚îÇ  - Verify JWT and agent ownership                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: Calculate Diff                                         ‚îÇ
‚îÇ  - Get current assignments from DB                              ‚îÇ
‚îÇ  - to_add = new_ids - current_ids                              ‚îÇ
‚îÇ  - to_remove = current_ids - new_ids                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: Apply Changes (Transaction)                            ‚îÇ
‚îÇ  - DELETE FROM agent_knowledge_entry_assignments                ‚îÇ
‚îÇ    WHERE entry_id IN to_remove                                  ‚îÇ
‚îÇ  - INSERT INTO agent_knowledge_entry_assignments                ‚îÇ
‚îÇ    VALUES (agent_id, entry_id, account_id, enabled=true)       ‚îÇ
‚îÇ    FOR EACH entry_id IN to_add                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: Return Success                                         ‚îÇ
‚îÇ  - { success: true, assigned_count: X }                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND: Show Toast                                            ‚îÇ
‚îÇ  - toast.success('Knowledge base access updated')               ‚îÇ
‚îÇ  - UI reflects new assignment state                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 3. Agent Conversation - Context Injection

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  USER SENDS MESSAGE TO AGENT                                     ‚îÇ
‚îÇ  - Chat interface                                               ‚îÇ
‚îÇ  - Message: "What's in our Q4 report?"                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: Chat Handler                                           ‚îÇ
‚îÇ  - Receive message                                              ‚îÇ
‚îÇ  - Get agent_id from conversation                               ‚îÇ
‚îÇ  - Build conversation context                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: Call get_agent_knowledge_base_context()                ‚îÇ
‚îÇ  - PostgreSQL function                                          ‚îÇ
‚îÇ  - Params: agent_id, max_tokens=4000                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  DATABASE: Execute Function                                      ‚îÇ
‚îÇ  1. Query:                                                      ‚îÇ
‚îÇ     SELECT filename, summary, folder_name                       ‚îÇ
‚îÇ     FROM knowledge_base_entries kbe                             ‚îÇ
‚îÇ     JOIN knowledge_base_folders kbf ON kbe.folder_id = ...     ‚îÇ
‚îÇ     JOIN agent_knowledge_entry_assignments akea ON ...          ‚îÇ
‚îÇ     WHERE akea.agent_id = {agent_id}                            ‚îÇ
‚îÇ       AND akea.enabled = true                                   ‚îÇ
‚îÇ       AND kbe.is_active = true                                  ‚îÇ
‚îÇ       AND kbe.usage_context IN ('always', 'contextual')         ‚îÇ
‚îÇ     ORDER BY kbe.created_at DESC                                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  2. Loop through entries:                                       ‚îÇ
‚îÇ     - Estimate tokens (length / 4)                              ‚îÇ
‚îÇ     - Stop if exceeds max_tokens                                ‚îÇ
‚îÇ     - Append formatted entry to context                         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  3. Return formatted text:                                      ‚îÇ
‚îÇ     # KNOWLEDGE BASE                                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ     The following files are available in your knowledge base:   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ     ## Reports/Q4_Financial_Report.pdf                          ‚îÇ
‚îÇ     This quarterly financial report contains revenue analysis,  ‚îÇ
‚îÇ     expense breakdowns, and profit projections for Q4 2024...   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ     ## Policies/HR_Handbook.docx                                ‚îÇ
‚îÇ     Employee handbook covering company policies, benefits...    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: Build LLM Messages                                     ‚îÇ
‚îÇ  [                                                              ‚îÇ
‚îÇ    {                                                            ‚îÇ
‚îÇ      "role": "system",                                          ‚îÇ
‚îÇ      "content": "You are {agent_name}. {system_prompt}\n\n" +   ‚îÇ
‚îÇ                 "{knowledge_base_context}"                      ‚îÇ
‚îÇ    },                                                           ‚îÇ
‚îÇ    {                                                            ‚îÇ
‚îÇ      "role": "user",                                            ‚îÇ
‚îÇ      "content": "What's in our Q4 report?"                      ‚îÇ
‚îÇ    }                                                            ‚îÇ
‚îÇ  ]                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND: Call LLM API                                           ‚îÇ
‚îÇ  - OpenAI / Anthropic / etc.                                    ‚îÇ
‚îÇ  - Model has access to knowledge base summaries                 ‚îÇ
‚îÇ  - Can reference file contents in response                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LLM RESPONSE                                                    ‚îÇ
‚îÇ  "Based on the Q4 Financial Report in the knowledge base,       ‚îÇ
‚îÇ   our revenue for Q4 2024 shows a 15% increase compared to      ‚îÇ
‚îÇ   Q3. The report indicates strong performance in product        ‚îÇ
‚îÇ   sales and mentions upcoming expense projections..."           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND: Display Response                                      ‚îÇ
‚îÇ  - Stream response to chat UI                                   ‚îÇ
‚îÇ  - User sees agent referencing knowledge base                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Funcionalidades Principais

### 1. Gerenciamento de Pastas

**Criar Pasta:**
- Nome obrigat√≥rio (1-255 caracteres)
- Descri√ß√£o opcional
- Valida√ß√£o cross-platform (remove caracteres ilegais)
- Nomes √∫nicos (auto-incrementa se conflito: "Docs" ‚Üí "Docs 2")

**Editar Pasta:**
- Inline editing (click no nome)
- Valida√ß√£o em tempo real
- Feedback visual de erros
- Suporte a teclado (Enter para salvar, Esc para cancelar)

**Deletar Pasta:**
- Confirma√ß√£o obrigat√≥ria
- Remove todos os arquivos (cascade)
- Deleta arquivos f√≠sicos do S3
- Remove assignments de agentes

**Expandir/Recolher:**
- Click no chevron icon
- Lazy loading de entries (s√≥ carrega ao expandir)
- Estado persistido durante sess√£o
- Auto-expand em modo assignment

---

### 2. Gerenciamento de Arquivos

**Upload:**
- Single ou multiple files
- Progress tracking por pasta
- Limite: 50MB por arquivo
- Limite total: 50MB por usu√°rio
- Formatos suportados:
  - Texto: .txt, .md, .log, .json, .xml, .csv, .yml, .yaml
  - Documentos: .pdf, .docx
  - Code files: detecta automaticamente files text-based
- Gera√ß√£o autom√°tica de resumo via LLM

**Preview:**
- Modal com informa√ß√µes:
  - Nome do arquivo
  - Tamanho
  - Tipo (MIME)
  - Data de upload
  - Resumo completo gerado
  - Bot√£o de download
  - Bot√£o de editar resumo

**Editar Resumo:**
- Modal dedicado
- Textarea para edi√ß√£o livre
- Valida√ß√£o: 1-1000 caracteres
- Salva via API
- Atualiza `updated_at`

**Download:**
- Gera URL assinada do S3
- Download direto do arquivo original
- Preserva nome original

**Mover (Drag & Drop):**
- Arrasta arquivo para outra pasta
- Visual feedback durante drag
- Drag overlay com nome do arquivo
- Atualiza `folder_id` no banco
- Refresh autom√°tico das pastas envolvidas

**Deletar:**
- Confirma√ß√£o obrigat√≥ria
- Remove do S3
- Soft delete (ou hard delete conforme configura√ß√£o)
- Remove assignments automaticamente

---

### 3. Sistema de Atribui√ß√µes (Assignments)

**Interface de Sele√ß√£o:**
- Checkboxes em cada arquivo
- Checkbox na pasta (select/deselect all)
- Estado indeterminado (alguns selecionados)
- Feedback visual de estado

**Sincroniza√ß√£o:**
- Auto-save em cada mudan√ßa
- Optimistic UI updates
- Rollback em caso de erro
- Toast notifications

**L√≥gica de Atribui√ß√£o:**
- Muitos-para-muitos: m√∫ltiplos agentes podem acessar mesmo arquivo
- Granular: por arquivo, n√£o por pasta
- Ativa√ß√£o: flag `enabled` permite desativar sem deletar
- Auditoria: timestamp `assigned_at`

**Contexto do Agente:**
- Fun√ß√£o `get_agent_knowledge_base_context()` retorna texto formatado
- Limite de tokens configur√°vel (padr√£o 4000)
- Ordena√ß√£o por `created_at DESC` (mais recentes primeiro)
- Filtragem por `usage_context` ('always', 'contextual')

---

### 4. Valida√ß√£o e Sanitiza√ß√£o

**Caracteres Proibidos:**
- Windows: `< > : " / \ | ? *`
- Caracteres de controle: `\x00-\x1f`

**Nomes Reservados:**
- Windows: CON, PRN, AUX, NUL, COM1-9, LPT1-9

**Sanitiza√ß√£o Autom√°tica:**
- Remove emojis
- Substitui espa√ßos por underscores (em file paths S3)
- Remove caracteres ilegais
- Normaliza Unicode (NFKC)
- Limita comprimento (255 chars, 200 bytes UTF-8)

**Valida√ß√£o Frontend:**
- Valida√ß√£o em tempo real durante digita√ß√£o
- Feedback visual inline
- Mensagens de erro descritivas
- Previne submiss√£o de nomes inv√°lidos

**Valida√ß√£o Backend:**
- Double-check de todas as valida√ß√µes
- Prote√ß√£o contra bypass de valida√ß√£o client-side
- Gera√ß√£o autom√°tica de nomes √∫nicos
- Sanitiza√ß√£o for√ßada antes de salvar

---

### 5. Processamento de Arquivos com LLM

**Extra√ß√£o de Conte√∫do:**
- **TXT/JSON/XML/CSV/etc**: Detec√ß√£o de encoding com `chardet`, decode com fallback
- **PDF**: `PyPDF2.PdfReader` ‚Üí extrai texto de todas as p√°ginas
- **DOCX**: `python-docx` ‚Üí extrai todos os par√°grafos
- **Bin√°rios**: Placeholder descritivo

**Gera√ß√£o de Resumo:**

1. **Estimativa de Tokens**
   - Rough: 1 token ‚âà 4 caracteres
   - Calcula se conte√∫do cabe no contexto

2. **Estrat√©gia de Modelos**
   - Tenta em ordem de prioridade
   - Fallback autom√°tico em caso de falha
   - Cada modelo tem limite de contexto conhecido

3. **Chunking Inteligente**
   - Se conte√∫do > contexto: usa `_smart_chunk_content()`
   - Prioriza: in√≠cio + se√ß√µes-chave + final
   - Detecta: headers, listas, keywords importantes
   - Preserva estrutura sem√¢ntica

4. **Prompt Otimizado**
   ```
   Analyze this file and create a concise, actionable summary 
   for an AI agent's knowledge base.
   
   File: {filename}
   Content: {content}
   
   Generate a 2-3 sentence summary that captures:
   1. What this file contains
   2. Key information or purpose  
   3. When this knowledge would be useful
   
   Keep it under 200 words and make it actionable for context injection.
   ```

5. **Fallback Inteligente**
   - Se todos os LLMs falharem
   - Analisa conte√∫do (tipo, tamanho, linhas)
   - Gera resumo descritivo b√°sico
   - Inclui preview (primeiros 200 chars)

**Resultado:**
- Summary de 200-300 palavras
- Acion√°vel para agentes
- Otimizado para injection em contexto
- Armazenado em `knowledge_base_entries.summary`

---

## Valida√ß√£o e Seguran√ßa

### Row Level Security (RLS)

Todas as tabelas t√™m RLS habilitado:

```sql
ALTER TABLE knowledge_base_folders ENABLE ROW LEVEL SECURITY;
ALTER TABLE knowledge_base_entries ENABLE ROW LEVEL SECURITY;
ALTER TABLE agent_knowledge_entry_assignments ENABLE ROW LEVEL SECURITY;
```

**Pol√≠ticas:**

```sql
CREATE POLICY kb_folders_account_access ON knowledge_base_folders
    FOR ALL USING (basejump.has_role_on_account(account_id) = true);

CREATE POLICY kb_entries_account_access ON knowledge_base_entries
    FOR ALL USING (basejump.has_role_on_account(account_id) = true);

CREATE POLICY kb_entry_assignments_account_access ON agent_knowledge_entry_assignments
    FOR ALL USING (basejump.has_role_on_account(account_id) = true);
```

**Efeito:**
- Usu√°rios s√≥ veem/modificam seus pr√≥prios dados
- Isolamento por conta (multi-tenant)
- Aplicado no n√≠vel do banco de dados
- Imposs√≠vel bypass via API

---

### Autentica√ß√£o JWT

**Depend√™ncia FastAPI:**
```python
user_id: str = Depends(verify_and_get_user_id_from_jwt)
```

**Fluxo:**
1. Frontend obt√©m token JWT do Supabase Auth
2. Inclui em header: `Authorization: Bearer {token}`
3. Backend valida token
4. Extrai `user_id` (= `account_id`)
5. Usa para queries com RLS

---

### Valida√ß√£o de Ownership

Antes de modificar qualquer recurso:

```python
# Exemplo: deletar pasta
folder_result = await client.table('knowledge_base_folders').select(
    'folder_id'
).eq('folder_id', folder_id).eq('account_id', account_id).execute()

if not folder_result.data:
    raise HTTPException(status_code=404, detail="Folder not found")
```

**Prote√ß√£o contra:**
- Modificar recursos de outros usu√°rios
- Cross-tenant data access
- UUID guessing attacks

---

### Limites e Quotas

**Arquivo Individual:**
- M√°ximo: 50MB
- Validado no upload
- Rejeita com HTTP 413

**Total por Usu√°rio:**
- M√°ximo: 50MB (soma de todos os arquivos)
- Verificado antes de aceitar novo upload
- Retorna erro descritivo com tamanhos atuais

**Implementa√ß√£o:**
```python
async def check_total_file_size_limit(account_id: str, new_file_size: int):
    result = await client.table('knowledge_base_entries').select(
        'file_size'
    ).eq('account_id', account_id).eq('is_active', True).execute()
    
    current_total = sum(entry['file_size'] for entry in result.data)
    new_total = current_total + new_file_size
    
    if new_total > MAX_TOTAL_FILE_SIZE:
        raise HTTPException(status_code=413, detail="File size limit exceeded")
```

---

### Storage Security

**S3 Paths:**
- Estruturados: `knowledge-base/{folder_id}/{entry_id}/{filename}`
- UUIDs previnem enumera√ß√£o
- Nomes sanitizados previnem path traversal

**Supabase Storage:**
- Signed URLs para download
- Controle de acesso via RLS
- Encryption at rest
- Automatic backup

---

### Valida√ß√£o de Input

**Nomes de Pasta/Arquivo:**
- Sanitiza√ß√£o autom√°tica
- Rejei√ß√£o de caracteres ilegais
- Preven√ß√£o de nomes reservados
- Limit de comprimento

**Conte√∫do de Arquivo:**
- Valida√ß√£o de MIME type
- Verifica√ß√£o de tamanho
- Detec√ß√£o de encoding
- Scan de conte√∫do malicioso (via content analysis)

**Resumos:**
- Comprimento m√≠nimo/m√°ximo
- Valida√ß√£o de Unicode
- Escape de caracteres especiais

---

## Integra√ß√£o com Agentes

### Quando o Contexto √© Injetado

**Cen√°rios:**

1. **In√≠cio de Conversa**
   - Primeira mensagem do usu√°rio
   - Context inclui knowledge base

2. **A Cada Mensagem (opcional)**
   - Configur√°vel por agente
   - √ötil para conversas longas

3. **Sob Demanda**
   - Uso de `usage_context = 'on_request'`
   - Agente solicita explicitamente

---

### Formato do Contexto

```markdown
# KNOWLEDGE BASE

The following files are available in your knowledge base:

## Policies/Employee_Handbook.pdf
This employee handbook outlines company policies including time-off procedures, 
expense reimbursement guidelines, and professional conduct expectations. Use 
this when employees ask about company policies or HR-related questions.

## Reports/Q4_2024_Financial_Summary.xlsx
Financial summary for Q4 2024 showing revenue growth of 15%, expense breakdown 
by department, and profit projections for Q1 2025. Reference this for questions 
about company financial performance or budget planning.

## Tech_Docs/API_Integration_Guide.md
Technical documentation for integrating with our REST API, including 
authentication flows, endpoint descriptions, and code examples in Python 
and JavaScript. Use when developers ask about API integration.
```

---

### Token Management

**Limite Padr√£o: 4000 tokens**

Raz√£o:
- GPT-4: 8K context ‚Üí reservar ~4K para conversa
- Claude: 100K context ‚Üí pode aumentar limite
- Deixa espa√ßo para system prompt + hist√≥rico

**Estimativa de Tokens:**
```python
estimated_tokens = (current_length + entry_length) / 4
if estimated_tokens > p_max_tokens:
    EXIT LOOP  # Para de adicionar entries
```

**Ordena√ß√£o:**
- `ORDER BY created_at DESC`
- Arquivos mais recentes t√™m prioridade
- Assume que conte√∫do novo √© mais relevante

---

### Usage Context

Tr√™s modos:

**1. `always`** (padr√£o)
- Sempre inclu√≠do no contexto
- Usado para informa√ß√£o fundamental
- Exemplo: pol√≠ticas da empresa, FAQs

**2. `on_request`**
- Inclu√≠do apenas quando solicitado
- Agente decide quando buscar
- Exemplo: documenta√ß√£o t√©cnica detalhada

**3. `contextual`**
- Inclu√≠do baseado em an√°lise de contexto
- Futuro: embeddings + semantic search
- Exemplo: caso espec√≠fico relevante √† conversa

**Implementa√ß√£o Atual:**
```sql
WHERE kbe.usage_context IN ('always', 'contextual')
```

---

### Exemplo de Uso pelo Agente

**Conversa:**

```
User: Qual √© nossa pol√≠tica de f√©rias?

Agent: (recebe contexto com Employee_Handbook.pdf)
        
        Baseado no Employee Handbook, nossa pol√≠tica de f√©rias 
        oferece 15 dias por ano para funcion√°rios em tempo integral, 
        acumulados mensalmente. Voc√™ precisa solicitar f√©rias com 
        pelo menos 2 semanas de anteced√™ncia atrav√©s do portal RH.
        
User: E se eu quiser f√©rias n√£o remuneradas?

Agent: O handbook menciona que f√©rias n√£o remuneradas podem ser 
        solicitadas em casos especiais, mas requerem aprova√ß√£o do 
        gerente e RH. Voc√™ quer que eu te ajude a iniciar esse 
        processo?
```

**Resultado:**
- Agente responde com informa√ß√£o precisa
- Referencia documentos da knowledge base
- N√£o inventa pol√≠ticas
- Pode citar fonte espec√≠fica

---

## Considera√ß√µes de Performance

### Lazy Loading

**Problema:** Carregar todos os arquivos de todas as pastas √© lento.

**Solu√ß√£o:**
- Pastas come√ßam recolhidas
- Entries s√≥ s√£o carregados ao expandir
- Cache em `folderEntries` state
- Evita re-fetch desnecess√°rio

**Exce√ß√£o:** Assignment mode auto-expande e carrega tudo (necess√°rio para checkboxes).

---

### React Query Caching

```typescript
const { folders, loading, refetch } = useKnowledgeFolders();
```

**Benef√≠cios:**
- Cache autom√°tico de `folders` e `recentFiles`
- Invalida√ß√£o inteligente ap√≥s mutations
- Background refetch
- Deduplica requests simult√¢neos

**Invalida√ß√£o:**
```typescript
queryClient.invalidateQueries({ queryKey: knowledgeBaseKeys.all });
```

---

### Database Indexes

Todos criados para performance:

```sql
CREATE INDEX idx_kb_folders_account_id ON knowledge_base_folders(account_id);
CREATE INDEX idx_kb_entries_folder_id ON knowledge_base_entries(folder_id);
CREATE INDEX idx_kb_entries_account_id ON knowledge_base_entries(account_id);
CREATE INDEX idx_kb_entry_assignments_agent_id ON agent_knowledge_entry_assignments(agent_id);
CREATE INDEX idx_kb_entry_assignments_entry_id ON agent_knowledge_entry_assignments(entry_id);
```

**Queries Otimizadas:**
- Busca por conta: O(log n)
- Busca por pasta: O(log n)
- Busca por agente: O(log n)
- Joins s√£o eficientes

---

### S3 Storage Performance

**Vantagens:**
- Storage separado do banco de dados
- Escal√°vel infinitamente
- CDN-ready (Supabase Storage usa CDN)
- Download direto (n√£o passa pelo backend)

**Paths Estruturados:**
```
knowledge-base/
  ‚îú‚îÄ‚îÄ {folder_id_1}/
  ‚îÇ   ‚îú‚îÄ‚îÄ {entry_id_1}/
  ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ document.pdf
  ‚îÇ   ‚îî‚îÄ‚îÄ {entry_id_2}/
  ‚îÇ       ‚îî‚îÄ‚îÄ spreadsheet.xlsx
  ‚îî‚îÄ‚îÄ {folder_id_2}/
      ‚îî‚îÄ‚îÄ {entry_id_3}/
          ‚îî‚îÄ‚îÄ report.docx
```

**Benef√≠cio:** F√°cil listar, mover, deletar por pasta.

---

### LLM Summary Caching

**Observa√ß√£o:** Resumos s√£o gerados uma vez no upload e armazenados no banco.

**Vantagens:**
- N√£o re-processa arquivo a cada contexto injection
- Resposta instant√¢nea ao carregar contexto
- Reduz custos de API LLM

**Trade-off:**
- Resumos n√£o atualizam se arquivo mudar
- Solu√ß√£o: Re-upload ou edi√ß√£o manual de resumo

---

## Melhorias Futuras

### 1. Semantic Search

**Problema Atual:** Context injection √© limitado por tokens e ordem cronol√≥gica.

**Solu√ß√£o:**
- Gerar embeddings dos resumos
- Armazenar em `pgvector` (PostgreSQL extension)
- Semantic search baseado na query do usu√°rio
- Ranking por relev√¢ncia

**Implementa√ß√£o:**
```sql
-- Adicionar coluna
ALTER TABLE knowledge_base_entries 
ADD COLUMN summary_embedding vector(1536);

-- Semantic search
SELECT * FROM knowledge_base_entries
WHERE agent_id = {id}
ORDER BY summary_embedding <=> query_embedding
LIMIT 5;
```

---

### 2. Versioning de Arquivos

**Feature:**
- Manter hist√≥rico de vers√µes
- Comparar mudan√ßas
- Rollback para vers√£o anterior

**Schema:**
```sql
CREATE TABLE knowledge_base_entry_versions (
    version_id UUID PRIMARY KEY,
    entry_id UUID REFERENCES knowledge_base_entries(entry_id),
    version_number INTEGER,
    file_path TEXT,
    summary TEXT,
    created_at TIMESTAMPTZ,
    created_by UUID
);
```

---

### 3. Collaborative Editing

**Feature:**
- M√∫ltiplos usu√°rios podem editar resumos
- Real-time sync via Supabase Realtime
- Conflict resolution

---

### 4. Advanced File Types

**Suportar:**
- Imagens: OCR + image description via Vision API
- V√≠deos: Transcri√ß√£o + key frames analysis
- Audio: Speech-to-text
- Code: AST parsing + docstring extraction
- Planilhas: Schema extraction + data summary

---

### 5. Hierarchical Folders

**Problema Atual:** Apenas um n√≠vel (pastas ‚Üí arquivos).

**Solu√ß√£o:**
- Pastas dentro de pastas
- Tree structure ilimitado
- Breadcrumb navigation

**Schema:**
```sql
ALTER TABLE knowledge_base_folders
ADD COLUMN parent_folder_id UUID REFERENCES knowledge_base_folders(folder_id);
```

---

### 6. Shared Knowledge Bases

**Feature:**
- Compartilhar pasta com outros usu√°rios
- Permissions: read-only vs. read-write
- Team collaboration

**Schema:**
```sql
CREATE TABLE knowledge_base_shares (
    share_id UUID PRIMARY KEY,
    folder_id UUID REFERENCES knowledge_base_folders(folder_id),
    shared_with_account_id UUID REFERENCES basejump.accounts(id),
    permission_level VARCHAR(50) CHECK (permission_level IN ('read', 'write')),
    created_at TIMESTAMPTZ
);
```

---

### 7. Auto-Tagging

**Feature:**
- LLM extrai tags do conte√∫do
- Tags facilitam busca e organiza√ß√£o
- Auto-complete ao digitar

**Schema:**
```sql
CREATE TABLE knowledge_base_tags (
    tag_id UUID PRIMARY KEY,
    entry_id UUID REFERENCES knowledge_base_entries(entry_id),
    tag_name VARCHAR(100),
    confidence FLOAT
);
```

---

### 8. Usage Analytics

**M√©tricas:**
- Quais arquivos s√£o mais referenciados por agentes
- Frequ√™ncia de uso por arquivo
- Effectiveness scoring (conversas bem-sucedidas)

**Schema:**
```sql
CREATE TABLE knowledge_base_usage_log (
    log_id UUID PRIMARY KEY,
    entry_id UUID REFERENCES knowledge_base_entries(entry_id),
    agent_id UUID REFERENCES agents(agent_id),
    conversation_id UUID,
    used_at TIMESTAMPTZ,
    effectiveness_score FLOAT
);
```

---

## Troubleshooting

### Problema: Upload falha com erro 413

**Causa:** Arquivo ou total excede limite de 50MB.

**Solu√ß√£o:**
1. Verificar tamanho do arquivo individual
2. Verificar total de arquivos do usu√°rio:
   ```sql
   SELECT SUM(file_size) FROM knowledge_base_entries 
   WHERE account_id = '{user_id}' AND is_active = true;
   ```
3. Deletar arquivos antigos ou desnecess√°rios
4. Considerar aumentar limite (requer mudan√ßa de c√≥digo)

---

### Problema: LLM summary est√° vazio ou gen√©rico

**Causa:** 
- Todos os modelos LLM falharam
- Conte√∫do muito grande (chunking inadequado)
- Arquivo bin√°rio sem conte√∫do extra√≠vel

**Solu√ß√£o:**
1. Verificar logs do backend:
   ```
   ERROR: Model google/gemini-2.5-flash-lite failed: {error}
   ERROR: All LLM models failed, using fallback
   ```
2. Re-upload arquivo (retry pode ter sucesso)
3. Editar resumo manualmente via UI
4. Verificar se arquivo √© tipo suportado

---

### Problema: Arquivo n√£o aparece no contexto do agente

**Checklist:**
1. Arquivo est√° atribu√≠do ao agente?
   - Verificar checkboxes em Assignment mode
2. Arquivo est√° ativo?
   ```sql
   SELECT is_active FROM knowledge_base_entries WHERE entry_id = '{id}';
   ```
3. `usage_context` est√° correto?
   - Deve ser 'always' ou 'contextual'
4. Token limit n√£o foi excedido?
   - Verificar se outros arquivos consomem todo o limite
5. RLS est√° permitindo acesso?
   - Testar query manualmente no DB

---

### Problema: Drag & drop n√£o funciona

**Poss√≠veis causas:**
1. Item n√£o √© arrast√°vel (tenta arrastar pasta?)
   - Solu√ß√£o: S√≥ arquivos s√£o arrast√°veis
2. Target n√£o √© v√°lido (tenta soltar em arquivo?)
   - Solu√ß√£o: S√≥ pode soltar em pastas
3. JavaScript error no console
   - Solu√ß√£o: Verificar console do browser, reportar bug

---

### Problema: Valida√ß√£o de nome n√£o aceita nome v√°lido

**Debug:**
1. Ver mensagem de erro espec√≠fica
2. Testar com `FileNameValidator.validateName()`:
   ```python
   is_valid, error = FileNameValidator.validate_name("My Folder", "folder")
   print(is_valid, error)
   ```
3. Verificar se h√° caracteres invis√≠veis (copy/paste issues)
4. Tentar sanitizar primeiro:
   ```python
   sanitized = FileNameValidator.sanitize_name("My Folder")
   ```

---

## Conclus√£o

O sistema de Knowledge Base do Suna √© uma solu√ß√£o completa e robusta para gerenciamento de documentos com integra√ß√£o profunda em agentes de IA. 

**Principais caracter√≠sticas:**

‚úÖ **Organiza√ß√£o hier√°rquica** com pastas e arquivos  
‚úÖ **Upload e processamento** autom√°tico com LLM  
‚úÖ **Valida√ß√£o cross-platform** e sanitiza√ß√£o de nomes  
‚úÖ **Drag & drop** moderno e intuitivo  
‚úÖ **Atribui√ß√£o granular** a agentes espec√≠ficos  
‚úÖ **Injection autom√°tica** de contexto em conversas  
‚úÖ **Seguran√ßa** via RLS, JWT, e ownership validation  
‚úÖ **Performance** otimizada com lazy loading e caching  

O sistema est√° pronto para produ√ß√£o e preparado para escalar com melhorias futuras como semantic search, versioning, e collaborative editing.